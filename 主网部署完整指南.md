# 🚀 BSC 主网部署完整指南

## ⚠️ 重要提醒

这是主网部署，将使用真实资金！请务必：

1. ✅ 已在测试网充分测试
2. ✅ 理解所有操作流程
3. ✅ 确认钱包有足够余额
4. ✅ 做好资金安全准备

---

## 📋 你的配置信息

- **代币合约地址 (CA)**: `0x83dfb0f9a8059b3dd274b3f4d68da93520fc4444`
- **钱包私钥**: `2159c1bc...efd47d` (已隐藏)
- **网络**: BSC 主网 (Mainnet)

---

## 🔍 第一步：检查钱包余额

### 1.1 获取钱包地址

```bash
# 运行脚本获取钱包地址
node 获取主网钱包地址.js
```

你会看到类似输出：
```
📍 钱包地址: 0xYourWalletAddress...
```

### 1.2 在 BscScan 查看余额

访问: `https://bscscan.com/address/你的钱包地址`

**检查清单：**
- [ ] BNB 余额 ≥ 0.1 BNB
  - 用途：支付 Gas 费
  - 每笔转账约消耗 0.0001-0.0005 BNB
  - 建议保持至少 0.1 BNB

- [ ] 代币余额充足
  - 用途：发放给用户
  - 建议根据预期用户量准备
  - 可以随时充值

### 1.3 如果余额不足

**充值 BNB:**
- 从交易所购买并提现到你的钱包地址
- 或从其他钱包转账

**充值代币:**
- 从代币部署钱包转账
- 或从交易所提现（如果代币已上所）

---

## 🚀 第二步：部署 Cloud Functions

### 方式一：使用自动化脚本（推荐）

```batch
# 双击运行
主网配置命令.bat
```

脚本会自动：
1. ✅ 安装 Firebase CLI
2. ✅ 登录 Firebase
3. ✅ 配置环境变量（代币CA、私钥、主网）
4. ✅ 安装依赖
5. ✅ 部署到 Firebase

### 方式二：手动执行命令

```bash
# 1. 安装 Firebase CLI
npm install -g firebase-tools

# 2. 登录
firebase login

# 3. 配置代币合约地址
firebase functions:config:set token.contract_address="0x83dfb0f9a8059b3dd274b3f4d68da93520fc4444"

# 4. 配置钱包私钥
firebase functions:config:set wallet.private_key="2159c1bcc01193026d313f98a11276f7ed2efe12fba8a0484272b922aaefd47d"

# 5. 设置为主网
firebase functions:config:set bsc.use_testnet="false"

# 6. 设置主网 RPC
firebase functions:config:set bsc.rpc_url="https://bsc-dataseed1.binance.org/"

# 7. 查看配置
firebase functions:config:get

# 8. 安装依赖
cd functions
npm install
cd ..

# 9. 部署
firebase deploy --only functions
```

---

## 🧪 第三步：小额测试（重要！）

⚠️ **强烈建议先用小额测试，确认一切正常后再大规模使用！**

### 3.1 查询钱包状态

打开浏览器，访问 `snake.html`，在控制台执行：

```javascript
const getStatus = firebase.functions().httpsCallable('getWalletStatus');

getStatus().then(result => {
    console.log('========================================');
    console.log('         钱包状态查询');
    console.log('========================================');
    console.log('钱包地址:', result.data.walletAddress);
    console.log('BNB 余额:', result.data.bnbBalance, 'BNB');
    console.log('代币余额:', result.data.tokenBalance);
    console.log('代币符号:', result.data.tokenSymbol);
    console.log('网络:', result.data.network);
    console.log('合约地址:', result.data.contractAddress);
    console.log('========================================');
}).catch(error => {
    console.error('❌ 查询失败:', error);
});
```

**预期输出:**
```
钱包地址: 0x...
BNB 余额: 0.15 BNB
代币余额: 100000
代币符号: YOUR_TOKEN
网络: BSC Mainnet
合约地址: 0x83dfb0f9a8059b3dd274b3f4d68da93520fc4444
```

### 3.2 小额转账测试（1 积分 = 10 代币）

**步骤：**

1. **在 Firebase 数据库设置测试积分**
   - 访问: https://console.firebase.google.com/
   - 项目: chat-294cc
   - Realtime Database → 数据
   - 创建路径: `users/你的测试钱包地址/score = 1`

2. **执行测试转账**
   ```javascript
   const claimToken = firebase.functions().httpsCallable('claimToken');
   
   claimToken({ 
       wallet: '你的测试钱包地址' 
   }).then(result => {
       console.log('========================================');
       console.log('         转账成功！');
       console.log('========================================');
       console.log('✅ 交易哈希:', result.data.tx);
       console.log('✅ 区块号:', result.data.blockNumber);
       console.log('✅ 转账数量:', result.data.amount, '代币');
       console.log('✅ 查看交易:', result.data.explorerUrl);
       console.log('========================================');
       
       // 自动打开 BscScan 查看交易
       window.open(result.data.explorerUrl, '_blank');
   }).catch(error => {
       console.error('❌ 转账失败:', error);
       console.error('错误详情:', error.message);
   });
   ```

3. **在 BscScan 验证**
   - 自动打开的页面或访问: https://bscscan.com/tx/交易哈希
   - 检查：
     - ✅ Status: Success (成功)
     - ✅ From: 发款钱包地址
     - ✅ To: 代币合约地址
     - ✅ Tokens Transferred: 看到代币转账记录

4. **检查接收地址余额**
   - 访问: https://bscscan.com/address/你的测试钱包地址
   - 在 "Token" 标签页查看代币余额是否增加

---

## 📊 第四步：监控与管理

### 4.1 查看 Cloud Functions 日志

```bash
# 实时查看日志
firebase functions:log --only claimToken

# 查看最近的日志
firebase functions:log --lines 100
```

### 4.2 Firebase 控制台监控

访问: https://console.firebase.google.com/

- **Functions**: 
  - 查看函数调用次数
  - 监控错误率
  - 查看执行时间

- **Realtime Database**:
  - `transactions/` - 查看成功的交易记录
  - `failedTransactions/` - 查看失败的交易
  - `users/` - 查看用户积分

### 4.3 钱包余额监控

定期检查发款钱包余额：

```javascript
// 在浏览器控制台定期执行
const getStatus = firebase.functions().httpsCallable('getWalletStatus');
getStatus().then(r => {
    console.log('BNB:', r.data.bnbBalance);
    console.log('代币:', r.data.tokenBalance);
});
```

**设置告警：**
- BNB < 0.05: 需要充值
- 代币 < 预估一周使用量: 需要充值

---

## 🔒 安全检查清单

### 部署前
- [ ] 已在测试网充分测试
- [ ] 确认配置信息正确
- [ ] 钱包余额充足
- [ ] 理解转账流程

### 部署后
- [ ] 小额测试成功
- [ ] 日志无错误
- [ ] 交易在 BscScan 可查
- [ ] 代币实际到账

### 日常维护
- [ ] 定期检查钱包余额
- [ ] 监控交易记录
- [ ] 查看错误日志
- [ ] 备份重要数据

---

## 💰 费用预估

### 每笔转账成本

**Gas 费用:**
- Gas 消耗: ~50,000 Gas
- Gas Price: ~5 Gwei
- 费用: ~0.00025 BNB ≈ $0.075

**代币成本:**
- 1 积分 = 10 代币
- 10 积分 = 100 代币
- 100 积分 = 1000 代币

### 月度预估（10,000 次转账）

- Gas 费: ~2.5 BNB ≈ $750
- Firebase: ~$0.02
- **总计: ~$750**

---

## ❓ 常见问题

### Q: 如何充值钱包？
**A:** 
1. 复制钱包地址
2. 从交易所或其他钱包转账
3. 等待确认后刷新余额

### Q: Gas 费不够怎么办？
**A:** 向钱包地址转入更多 BNB

### Q: 如何更换发款钱包？
**A:**
```bash
# 1. 转移旧钱包资产
# 2. 更新配置
firebase functions:config:set wallet.private_key="新钱包私钥"
firebase deploy --only functions
```

### Q: 如何暂停服务？
**A:**
```bash
# 方法1: 删除函数
firebase functions:delete claimToken

# 方法2: 在代码中添加维护模式检查
```

### Q: 交易失败如何处理？
**A:**
1. 查看 `failedTransactions/` 数据库记录
2. 检查钱包余额
3. 查看详细错误日志
4. 必要时手动处理

---

## 🆘 紧急情况处理

### 私钥泄露
1. ⚠️ 立即将所有资产转移到新钱包
2. 更新配置为新钱包私钥
3. 重新部署
4. 废弃旧钱包

### 余额耗尽
1. 暂停游戏（避免用户积分无法兑换）
2. 充值钱包
3. 测试转账
4. 恢复游戏

### 大量异常交易
1. 查看日志找出原因
2. 必要时暂停服务
3. 修复问题
4. 重新部署

---

## ✅ 部署完成确认

完成以下检查后，系统即可投入使用：

- [ ] 主网配置已部署
- [ ] 小额测试转账成功
- [ ] BscScan 可查看交易
- [ ] 钱包余额充足（BNB + 代币）
- [ ] Firebase 日志正常
- [ ] 监控系统已设置
- [ ] 了解紧急处理流程

---

## 📞 技术支持

遇到问题时：

1. 查看日志: `firebase functions:log`
2. 检查配置: `firebase functions:config:get`
3. 查看文档: TESTING_GUIDE.md
4. 检查 BscScan 交易详情

---

**主网部署完成！祝运营顺利！** 🎉

记住：
- 定期检查钱包余额
- 监控交易日志
- 做好数据备份
- 保管好私钥

