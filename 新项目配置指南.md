# 🔧 新 Firebase 项目配置指南

## 项目信息

- **项目ID**: `big-pig-38efe`
- **项目名称**: Big Pig
- **控制台**: https://console.firebase.google.com/project/big-pig-38efe

---

## 📋 配置步骤

### 第 1 步：切换 Firebase 项目

在 PowerShell 中运行：

```powershell
firebase use big-pig-38efe
```

或者双击运行批处理文件：
```
切换到新项目.bat
```

---

### 第 2 步：在 Firebase 控制台启用必要服务

访问：https://console.firebase.google.com/project/big-pig-38efe

#### 2.1 启用 Firestore（聊天室功能）

1. 左侧菜单 → **Firestore Database**
2. 点击 **"创建数据库"**
3. 选择 **"以测试模式启动"**（稍后会更新规则）
4. 选择服务器位置（推荐：`asia-southeast1` - 新加坡）
5. 点击 **"启用"**

#### 2.2 启用 Realtime Database（游戏功能）

1. 左侧菜单 → **Realtime Database**
2. 点击 **"创建数据库"**
3. 选择服务器位置（推荐：`asia-southeast1` - 新加坡）
4. 选择 **"以测试模式启动"**
5. 点击 **"启用"**

#### 2.3 升级到 Blaze 方案（Cloud Functions）

1. 左下角点击 **"升级"** 或 **"Upgrade"**
2. 选择 **"Blaze - 按量付费"**
3. 绑定支付方式（信用卡/借记卡）
4. 确认升级

**💰 费用说明：**
- Cloud Functions 每月有大量免费额度
- 预估费用：基本在免费范围内
- 建议设置预算警报（如 $10/月）

---

### 第 3 步：配置数据库规则

#### 3.1 Firestore 规则

访问：https://console.firebase.google.com/project/big-pig-38efe/firestore/rules

粘贴以下规则：

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 用户集合：只能读取自己的数据，创建时自动设置
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth == null && request.resource.data.username is string;
      allow update, delete: if false;
    }
    
    // 消息集合：已登录用户可读写
    match /messages/{messageId} {
      allow read: if true;
      allow create: if request.resource.data.username is string && 
                       request.resource.data.message is string &&
                       request.resource.data.timestamp is number;
      allow delete: if true; // 允许清空聊天
      allow update: if false;
    }
  }
}
```

点击 **"发布"**。

#### 3.2 Realtime Database 规则

访问：https://console.firebase.google.com/project/big-pig-38efe/database/rules

粘贴以下规则：

```json
{
  "rules": {
    "rooms": {
      ".read": true,
      ".write": true,
      "$roomId": {
        "players": {
          ".indexOn": ["score"]
        }
      }
    },
    "gameSettings": {
      ".read": true,
      ".write": true
    },
    "admin": {
      ".read": true,
      ".write": true
    }
  }
}
```

点击 **"发布"**。

---

### 第 4 步：配置 Cloud Functions

#### 4.1 确认项目已切换

```powershell
firebase use
```

应该显示：`big-pig-38efe (current)`

#### 4.2 配置主网环境变量

**运行主网配置命令：**

```powershell
# 方式1：手动配置（推荐）
firebase functions:config:set token.contract_address="0x83dfb0f9a8059b3dd274b3f4d68da93520fc4444"
firebase functions:config:set wallet.private_key="2159c1bcc01193026d313f98a11276f7ed2efe12fba8a0484272b922aaefd47d"
firebase functions:config:set bsc.use_testnet="false"
firebase functions:config:set bsc.rpc_url="https://bsc-dataseed1.binance.org/"

# 方式2：运行批处理文件
.\主网配置命令.bat
```

#### 4.3 验证配置

```powershell
firebase functions:config:get
```

应该显示：

```json
{
  "bsc": {
    "rpc_url": "https://bsc-dataseed1.binance.org/",
    "use_testnet": "false"
  },
  "token": {
    "contract_address": "0x83dfb0f9a8059b3dd274b3f4d68da93520fc4444"
  },
  "wallet": {
    "private_key": "2159c1bcc01193026d313f98a11276f7ed2efe12fba8a0484272b922aaefd47d"
  }
}
```

---

### 第 5 步：部署 Cloud Functions

#### 5.1 安装依赖

```powershell
cd functions
npm install
cd ..
```

#### 5.2 部署函数

```powershell
firebase deploy --only functions
```

如果出现计费错误，确保已升级到 Blaze 方案（第 2.3 步）。

#### 5.3 验证部署

访问：https://console.firebase.google.com/project/big-pig-38efe/functions

应该看到 3 个已部署的函数：
- `claimToken`
- `getTokenBalance`
- `getWalletStatus`

---

### 第 6 步：获取发款钱包地址

运行：

```powershell
node 获取主网钱包地址.js
```

应该输出：

```
========================================
  BSC 主网钱包地址
========================================

钱包地址: 0x...
私钥 (前8位): 2159c1bc...

========================================
  接下来请：
========================================
1. 充值 BNB 到该地址用于 Gas 费 (至少 0.1 BNB)
2. 充值代币到该地址用于发放奖励
3. 在 BSCScan 查看余额: https://bscscan.com/address/0x...
```

---

### 第 7 步：充值钱包

1. **复制钱包地址**（从上一步获取）
2. **充值 BNB**：至少 0.1 BNB 用于 Gas 费
3. **充值代币**：发送足够的代币到该地址
4. **验证余额**：访问 https://bscscan.com/address/YOUR_ADDRESS

---

### 第 8 步：测试功能

#### 8.1 测试聊天室

1. 打开 `index.html`
2. 点击 "Chat Room"
3. 注册并登录
4. 发送消息
5. 检查 Firestore 中是否有数据

#### 8.2 测试游戏

1. 打开 `index.html`
2. 点击 "Multiplayer Snake Game"
3. 输入 BSC 钱包地址（0x...）
4. 开始游戏
5. 检查 Realtime Database 中是否有数据

#### 8.3 测试代币兑换

1. 在游戏中获得积分（吃满 100 个食物）
2. 点击 "Claim Tokens"
3. 检查交易：https://bscscan.com
4. 验证代币是否到账

---

## ✅ 配置完成检查清单

- [ ] Firebase 项目已切换到 `big-pig-38efe`
- [ ] Firestore 已启用并配置规则
- [ ] Realtime Database 已启用并配置规则
- [ ] 已升级到 Blaze 计费方案
- [ ] Cloud Functions 环境变量已配置
- [ ] Cloud Functions 已成功部署
- [ ] 发款钱包已充值 BNB 和代币
- [ ] 聊天室功能测试通过
- [ ] 游戏功能测试通过
- [ ] 代币兑换功能测试通过

---

## 🚨 常见问题

### Q1: 部署时提示 403 错误

**A:** 需要升级到 Blaze 方案并绑定支付方式。

### Q2: 游戏无法连接

**A:** 检查 Realtime Database 是否已启用，数据库规则是否正确。

### Q3: 聊天室无法发送消息

**A:** 检查 Firestore 是否已启用，数据库规则是否正确。

### Q4: 代币兑换失败

**A:** 
1. 检查钱包是否有足够的 BNB（Gas 费）
2. 检查钱包是否有足够的代币
3. 检查 Cloud Functions 日志：`firebase functions:log`

### Q5: 如何切换回测试网？

**A:** 运行：
```powershell
firebase functions:config:set bsc.use_testnet="true"
firebase deploy --only functions
```

---

## 📞 需要帮助？

如遇问题，请检查：
1. Firebase 控制台的错误日志
2. 浏览器控制台的错误信息
3. Cloud Functions 日志：`firebase functions:log`

---

**祝你部署顺利！** 🎉

